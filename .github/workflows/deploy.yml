name: Deploy to EC2 with Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Create .env file for production build (same as original deploy.yml)
      - name: Create production .env
        run: |
          cd client
          echo "VITE_API_URL=https://${{ secrets.EC2_DOMAIN }}/api" > .env
          echo "VITE_SERVER_URL=https://${{ secrets.EC2_DOMAIN }}/" >> .env
          echo "VITE_GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
          echo "VITE_STRIPE_PUBLIC_KEY=${{ secrets.STRIPE_PUBLIC_KEY }}" >> .env

      # Build React locally in GitHub Actions (same as original deploy.yml)
      - name: Build React
        run: |
          cd client
          npm ci
          npm run build

      # Setup new app directory (for git repository)
      - name: Setup git repository directory
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Ensure main directory exists
            mkdir -p ~/fullstack-ecommerce

      # Copy pre-built frontend to EC2 (to git repo location)
      - name: Copy frontend to EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Remove old dist and recreate
            rm -rf ~/fullstack-ecommerce/client/dist
            mkdir -p ~/fullstack-ecommerce/client/dist

      # Copy pre-built frontend to EC2 (to git repo location)
      - name: Copy frontend files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "client/dist/*"
          target: "~/fullstack-ecommerce/client/dist"
          strip_components: 2
          overwrite: true

      # Sync backend to EC2
      - name: Sync backend to EC2
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > deploy_key.pem
          chmod 600 deploy_key.pem
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude 'public' \
            --exclude '.migrations-initialized' \
            -e "ssh -i deploy_key.pem -o StrictHostKeyChecking=no" \
            server/ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/fullstack-ecommerce/server/
          rm -f deploy_key.pem

      # Deploy with Docker Compose
      - name: Deploy Docker containers
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/fullstack-ecommerce || exit 1
            
            # Pull latest changes
            git pull origin main
            
            # Ensure .env exists
            if [ ! -f .env ]; then
              echo "ERROR: .env file not found! Please create it on the server."
              exit 1
            fi
            
            # Stop old containers
            docker-compose down
            
            # Start containers (no build needed, using pre-built images)
            docker-compose up -d
            
            # Wait for services to be ready
            echo "Waiting for services to start..."
            sleep 15
            
            # Check service health
            docker-compose ps
            
            # Show recent logs
            echo "=== Recent logs ==="
            docker-compose logs --tail=50

      # Setup SSL certificates (non-blocking - site works with HTTP if this fails)
      - name: Setup SSL certificates
        uses: appleboy/ssh-action@v1.2.0
        continue-on-error: true
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/fullstack-ecommerce || exit 1
            
            echo "Attempting to setup SSL certificates..."
            chmod +x setup-ssl.sh
            ./setup-ssl.sh || true
            
            # Ensure nginx is running (with or without SSL)
            echo "Ensuring nginx is running..."
            docker-compose up -d nginx
            
            sleep 5
            docker-compose logs nginx --tail=20

      # Verify deployment
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/fullstack-ecommerce
            
            # Check if all containers are running
            RUNNING=$(docker-compose ps | grep -c "Up")
            if [ "$RUNNING" -lt 3 ]; then
              echo "ERROR: Not all services are running!"
              docker-compose logs
              exit 1
            fi
            
            echo "âœ… Deployment successful! All services running."

      # Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      # Invalidate CloudFront cache after successful deployment
      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/index.html" "/vite.svg" "/"
            # --paths "/*"
